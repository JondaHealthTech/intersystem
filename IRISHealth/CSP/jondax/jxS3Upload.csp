<html lang="en">   <!--Upload to S3 Staging Bucket-->
    <head>
    	<script language="cache" runat="server">d HEAD1^WSP999</script>
        <link rel="stylesheet" href="assets/styles/jxBuckets.css">
    </head>
    <body>
        <div id="wrapper">
            <div class="bg-wrapper">
                <div class="bg3">
                    <img src="./assets/images/bg3.png">
                </div>
            </div>
            <div class="content">
                <div class="main-field">
                    <img class="logo mobile-active" src="./assets/images/Jonda X Logo White Pink.png" alt="Jonda Health">
                    <h1>Transform your laboratory data</h1>
                    <h2>Upload your files</h2>
                    <!--
                    <div class="bucket-name-group ">
                    		<p>Bucket Name:</p>
                    		<div class="bucket-dropdown"><p class="bucket-name"></p></div>
                    </div>
                    <div class="bucket-data dropdown-data ">
                            <ul>
                            	<script language="cache" runat="server">
                            		;d WriteBuckets^jxBuckets
                            	</script>
                            </ul>
                     </div>
                     -->
                    <div id="lab-upload" class="lab-upload">
                        <h4>Upload laboratory file</h4>
                        <img src="assets/images/upload.png" alt="Upload">
                        <p>
                            Drag and drop here<br>
                            or<br>
                        </p>
                        <input
                            type="file"
                            accept=".png,.jpg,.heic,.avif,.webp,.pdf,.hl7,.xml,.json,.xlsx,.json"  
                            id="fileupload"
                            style="display: none"
                            onchange="changeFile(event)"
                            multiple
                       ><!--PDF, XLSX,XML, JSON, PNG, JPG, HEIC, AVIF, WEBP, HL7,  -->
                        <button onclick="openFileDialog(event)">Upload</button>
                        <p class="note">File Formats: <span style="display:;">Interoperatibility <span style="text-decoration:underline;text-decoration-style:dotted;cursor:help" title="HL7 v2, HL7 CDA and HL7 FHIR json/xml">File Standards</span><span>
                        , </span>PDF or <span style="text-decoration:underline;text-decoration-style:dotted;cursor:help" title="heic, jpg, jpeg, gif, webp">images</span></span>
                        .<br>Max size: 5MB per file| Page limit per PDF: 5 pages</p>
                    </div>
                    <div class="hr-group">
                        <hr>
                        <p class="num"></p>
                    </div></div>
            </div>
            <button
                class="inactive"
                id="BModal1"
                data-toggle="modal"
                data-target="#myModal1"
                type="button"
            >
            </button>
                Next
        </div>
        <div
            id="myModal1"
            class="modal fade"
            aria-labelledby="myModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog" style='display:none;'>
                <div class="modal-content">
                  <!--  <div class="modal-body">
                        <h2>Hang tight!</h2>
                        <h3>Uploading your files to bucket...</h3>
                        <img
                            class="modal-img"
                            src="assets/images/analyzeData.png"
                            alt="Analysing Data"
                       > 
                    </div> -->
                </div>
            </div>
        </div>

        <script>
            var resizefunc = [];
        </script>
        <!-- jQuery  -->
		<script language="cache" runat="server">
			d jQueryCore^WSP999
		</script>
    </body>
    <script type="text/javascript">
	window.onload=jInitMe();
    window.onload = parent.resetTimer;
	document.onmousemove = parent.resetTimer;
	document.onmousedown = parent.resetTimer; // touchscreen presses
	document.ontouchstart = parent.resetTimer;
	document.onkeypress = parent.resetTimer;
	document.addEventListener('scroll', parent.resetTimer, true);
	const bucketData = document.querySelector(".bucket-data");
	const fileUpload = document.getElementById("fileupload");
	const modalBtn = document.getElementById("BModal1");
	let uploadedFiles = [];
	let sFileCount=0;
	let totalFiles=0;
	
	function jInitMe(){
	    #server(..cInitMe())#
        }
      /*  not using, for bucket dropdown
    function openBucketDropdown(e){
        let position = e.target.getBoundingClientRect();
        bucketData.style.top = position.bottom + 2 + "px";
        bucketData.style.right =window.innerWidth - position.right + "px";
        setTimeout(()=>{
            bucketData.classList.add("active");
        },100);
        }
    function changeBK(e){
        let bk=e.target.textContent;
        document.querySelector(".bucket-name").innerHTML = bk;
        bucketData.classList.remove("active");
        
        }
	*/
	
	// Activate window dialog 
	function openFileDialog(e) {
	    fileUpload.click();
	}
	// For files ,choose and open from window dialog
	function changeFile(e) {
            uploadedFiles = e.target.files;
            #server(..cSetFileCount(uploadedFiles.length))#
            modalBtn.click();
            if (uploadedFiles.length > 0) {
	            files2Local();
            }
        } 
     // For drag and drop files   
    document.body.addEventListener("drop", (ev) => {
    		ev.preventDefault(); 
    		uploadedFiles = [];
    		if (ev.dataTransfer.items) {
       			 for (let i = 0; i < ev.dataTransfer.items.length; i++) {
            		if (ev.dataTransfer.items[i].kind === "file") {
                		uploadedFiles.push(ev.dataTransfer.items[i].getAsFile());
            		}
        		}
   			} else {
        		for (let i = 0; i < ev.dataTransfer.files.length; i++) {
           			uploadedFiles.push(ev.dataTransfer.files[i]);
        		}
    		}
    		#server(..cSetFileCount(uploadedFiles.length))#
    		modalBtn.click();
    		if (uploadedFiles.length > 0) {
       			files2Local();
    		}
   			removeDragData(ev);
	});

	document.body.addEventListener("dragover", (e) => {
    	e.preventDefault(); 
	});
	// clear drag files 
    function removeDragData(ev) {
        if (ev.dataTransfer.items) {
        	ev.dataTransfer.items.clear();
        } else {
            ev.dataTransfer.clearData();
        }
    } 
    // loop for file uload via POST method        
    function files2Local(){
     for (let i = 0; i < uploadedFiles.length; i++) {
                //console.log(`File ${i + 1}: ${uploadedFiles[i].name}`);
                jUploadFile(uploadedFiles[i],i+1);
            }
     }   
	//Upload file to server
	function jUploadFile(file,fCount) {
        var formData = new FormData();
        formData.append("fileupload", file);
        var fname = file.name.replace("&", " ");
		
		// Post request thru jxS3UploadRecord.csp, call UploadFiles^jxS3Upload
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "jxS3UploadRecord.csp?FName=" + fname, true);
        xhr.send(formData);

        xhr.onload = function (e) {
        if (this.status == 200) {
           // check all the files are in folder for success status
          #server(..cCheck(fCount))#
         }
        }
        
    }	 
    </script>
    
   <script language="cache" method="cInitMe">
	d InitMe^jxS3Upload
</script>   
<script language="cache" method="cSetFileCount" arguments="d1:%String">
	s ^jxS3Upload("Count")=d1
</script>    
<script language="cache" method="cCheck" arguments="d1:%String">
    s UserID=$g(%session.Data("UserID"))
    s sFile=$g(^jxS3Upload(UserID,"Upload","Success"))
    ;s failCount=$g(^jxS3Upload(UserID,"FailCount"))
	
	if ($g(^jxS3Upload(UserID,"Upload","Fail"))'=""){
	   s file =$g(^jxS3Upload(UserID,"Upload","Fail"))     
    }
    if $g(^jxS3Upload("Count"))=d1 
    {	s sFile=$g(^jxS3Upload(UserID,"Upload","Success"))
    	i sFile=0 {&js<alert("UPLOADING FAILS: " + `#(file)#`); window.location.reload();> }
    	else {
	    	&js<modalBtn.click();>
	    	s sts=$$S3Upload^jxS3Upload
	   		if sts>0{
		   		if $d(file) &js<alert("UPLOADED " + `#(sts)#` + " FILES!\nUPLOADING FAILS: " + `#(file)#`);>
		   		e  &js<alert("ALL FILES( "+ `#(sts)#`+") ARE UPLOADED SUCCESSFULLY!");window.open("jxS3Download.csp","_self");>
	   		}else {
		   		&js<alert("UPLOADING FAILS!!!")>
	   		}
    	}
   		
    }
    ; &js<console.log("success: "+`#(sFile)#`+ " now: "+`#(d1)#`+" Fail "+`#(failCount)#`);>
</script>
</html>
 