<html>		<!-- Country under System setting in Side Nav -->
<head>
<script language="cache" method="OnPreHTTP" arguments="" returntype="%Boolean">
	i $g(%session.Data("UserID"))="" s %response.Redirect="cLockDown.csp" q 1
	q 1
</script>

<script language="cache" runat="server">
	s r1="",id=$g(%session.Data("UserID")) &sql(SELECT IsAdmin INTO :r1 FROM "User" WHERE ID=:id)
	i r1'=1 s %response.Redirect="cLockDown.csp"
	d HEAD1^CSP999
</script>
	<link rel="stylesheet" href="assets/styles/cCountry.css" />
</head>
    <body>
        <div id="wrapper">
            <div class="bg-wrapper">
                <div class="bg3">
                    <img src="./assets/images/bg3.png">
                </div>
            </div>
            <div id="loader" class="loader">
            	<div class="loader-content">
            		<p>Please wait for all the data to be loaded!</p>
            		<div class="lds-ring"><div></div><div></div><div></div><div></div></div>
            	</div>
            </div>
            <div class="content">
                <div class="main-field">
                    <i class="fa fa-bars mobile-active nav-toggle" style="color: #ffffff;" onclick="openMobileNav(event)"></i>
                    <img class="logo mobile-active" src="./assets/images/Jonda X Logo White Pink.png" alt="Jonda Health">
                    <div class="title">
                    	<h1>Country</h1>
                    </div>
                    <div id="temp-content" class="temp-content">
                        <div class="filters">
                            <div class="text-fil">
                                <p onclick="jLoadCountries(event)">All</p>
                                <p onclick="jLoadCountries(event)">1-9</p>
                                <p onclick="jLoadCountries(event)">A</p>
                                <p onclick="jLoadCountries(event)">B</p>
                                <p onclick="jLoadCountries(event)">C</p>
                                <p onclick="jLoadCountries(event)">D</p>
                                <p onclick="jLoadCountries(event)">E</p>
                                <p onclick="jLoadCountries(event)">F</p>
                                <p onclick="jLoadCountries(event)">G</p>
                                <p onclick="jLoadCountries(event)">H</p>
                                <p onclick="jLoadCountries(event)">I</p>
                                <p onclick="jLoadCountries(event)">J</p>
                                <p onclick="jLoadCountries(event)">K</p>
                                <p onclick="jLoadCountries(event)">L</p>
                                <p onclick="jLoadCountries(event)">M</p>
                                <p onclick="jLoadCountries(event)">N</p>
                                <p onclick="jLoadCountries(event)">O</p>
                                <p onclick="jLoadCountries(event)">P</p>
                                <p onclick="jLoadCountries(event)">Q</p>
                                <p onclick="jLoadCountries(event)">R</p>
                                <p onclick="jLoadCountries(event)">S</p>
                                <p onclick="jLoadCountries(event)">T</p>
                                <p onclick="jLoadCountries(event)">U</p>
                                <p onclick="jLoadCountries(event)">V</p>
                                <p onclick="jLoadCountries(event)">W</p>
                                <p onclick="jLoadCountries(event)">X</p>
                                <p onclick="jLoadCountries(event)">Y</p>
                                <p onclick="jLoadCountries(event)">Z</p>
                            </div>
                            <div class="search-group">
                                <input type="text" id="search" placeholder="Search" onkeyup="searchDataChange(event)">
                                <img src="./assets/images/search icon.png" alt="Search" class="search-icon" onclick="jLoadSearchResults(1)">
                            </div>
                            <!--s<button class="filter-btn"><img src="./assets/images/filter.png" alt="Filter">Filters</button>-->
                        </div>
                        <div class="table-border"></div>
                        <div class="temp-table">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Country Code <div class="img-group"><img src="./assets/images/upArrow.png" alt="Up Arrow" onclick="jSortTable(1)"><img src="./assets/images/downArrow.png" alt="Down Arrow" onclick="jSortTable(2)"></div></th>
                                        <th>Name <div class="img-group"><img src="./assets/images/upArrow.png" alt="Up Arrow" onclick="jSortTable(3)"><img src="./assets/images/downArrow.png" alt="Down Arrow" onclick="jSortTable(4)"></div></th>
                                        <th>Date Format</th>
                                        <th>AWS Region <div class="img-group"><img src="./assets/images/upArrow.png" alt="Up Arrow" onclick="jSortTable(5)"><img src="./assets/images/downArrow.png" alt="Down Arrow" onclick="jSortTable(6)"></div></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="search-data dropdown-data">
                            <ul>
                            </ul>
                        </div>
                        <div class="date-format-data dropdown-data">
                            <ul>
                            	<li onclick="changeDateFormat(event)">dd/mm/yyyy</li>
                            	<li onclick="changeDateFormat(event)">mm/dd/yyyy</li>
                            </ul>
                        </div>
                        <button type="button" class="add-row" onclick="addRow(event)">Add Row</button>
                    	<div class="btn-edit-group">
                    		<button class="green-btn" onclick="saveRow()">Save Changes</button>
                    		<button class="pink-btn" onclick="cancelEdit()">Cancel</button>
                    	</div>
                    </div>
                </div>
            </div>
        </div><div id="popup1" class="popup inactive">
            <div class="popup-dialog">
                <img src="./assets/images/success.png" alt="FYI">
                <h4>Are you sure you want to delete "<span id="del-val"></span>"?</h4>
                <p>This action cannot be undone.</p>
                <div class="btn-group">
                    <button class="green-btn" onclick="confirmDelete()">Yes</button>
                    <button class="pink-btn" onclick="cancelDelete()">No</button>
                </div>
            </div>
        </div>
        <div id="popup2" class="popup inactive">
            <div class="popup-dialog">
                <img src="./assets/images/success.png" alt="FYI">
                <h4>"<span id="del-val1"></span>" is now deleted!</h4>
                <button class="green-btn" onclick="removePopup2()">Okay</button>
            </div>
        </div>
        <div id="popup3" class="popup inactive">
            <div class="popup-dialog">
                <img src="./assets/images/success.png" alt="FYI">
                <h4>Are you sure you want to save <span id="save-val"></span>?</h4>
                <div class="btn-group">
                    <button class="green-btn" onclick="confirmSave()">Yes</button>
                    <button class="pink-btn" onclick="removePopup3()">No</button>
                </div>
            </div>
        </div>
        <div id="popup4" class="popup inactive">
            <div class="popup-dialog">
                <img src="./assets/images/success.png" alt="FYI">
                <h4>Please make sure you fill up <br> the name!!</h4>
                <button class="green-btn" onclick="removePopup4()">Okay</button>
            </div>
        </div>
        <div id="popup5" class="popup inactive">
            <div class="popup-dialog">
                <img src="./assets/images/success.png" alt="FYI">
                <h4>"<span id="save-val1"></span>" is now saved!</h4>
                <button class="green-btn" onclick="removePopup5()">Okay</button>
            </div>
        </div>
        <div id="popup6" class="popup inactive">
            <div class="popup-dialog">
                <img src="./assets/images/success.png" alt="FYI">
                <h4>Changes are now saved!</h4>
                <button class="green-btn" onclick="removePopup6()">Okay</button>
            </div>
        </div>
        <script>
            var resizefunc = [];
        </script>
        <!-- jQuery  -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/bootstrap.min.js"></script>
        <script src="assets/js/detect.js"></script>
        <script src="assets/js/fastclick.js"></script>
        <script src="assets/js/jquery.slimscroll.js"></script>
        <script src="assets/js/jquery.blockUI.js"></script>
        <script src="assets/js/waves.js"></script>
        <script src="assets/js/wow.min.js"></script>
        <script src="assets/js/jquery.nicescroll.js"></script>
        <script src="assets/js/jquery.scrollTo.min.js"></script>
        <script src="assets/js/jquery.core.js"></script>
        <script src="assets/js/jquery.app.js"></script>
    </body>
    <script type="text/javascript">
    	let popup1 = document.getElementById("popup1");
       	let popup2 = document.getElementById("popup2");
        let popup3 = document.getElementById("popup3");
        let popup4 = document.getElementById("popup4");
        let popup5 = document.getElementById("popup5");
        let popup6 = document.getElementById("popup6");
        let dropDownText = " <img src='./assets/images/dropDownDarkBlue.png' alt='Dropdown'>"
        let searchData = document.querySelector(".search-data");
    	let dateFormatData = document.querySelector(".date-format-data");
    	let	searching;
    	let prevSearchData;
    	let currentLoadData = "";
    	let currentOrder = 1;
    	let currentTr;
    	let val1;
    	let val2;
    	let val3;
    	let val4;
    	let dataExist=false;
    	let lastViewDate;
    	window.onresize = setTableBorderPos;
        window.onload = jInitMe;
        function jInitMe(){
	        #server(..cInitMe())#
	        setTableBorderPos();
	    	document.getElementById("loader").style.display = "none";
        }
        
        // Set and Adjust table
        function setTableBorderPos(){
            let tableBorder = document.querySelector(".table-border");
            let tempTable = document.querySelector(".temp-table");
            let table = document.querySelector("table");
            
            setTimeout(()=>{
	            let tablePosition = table.getBoundingClientRect();//top,bottom,right,left,x,y,height,width
            	if(tempTable.scrollHeight > tempTable.clientHeight){
                	tableBorder.style.height = "calc(60vh + 4px)"
            	}
            	else{
		        	tableBorder.style.height = tablePosition.height + 4 + "px";
            	}
            	tableBorder.style.width = tablePosition.width + 4 + "px";
            },100);
        }
        
        // Populate the table
        function jLoadCountries(e){
	    	let start=e.target.textContent;
	    	searching=false;
	    	if(start.startsWith("1")){
		    	start="num"
	    	}
	    	if(start=="All"){
		    	start=""
	    	}
	    	if(currentLoadData==start && currentOrder==1){return;}
	    	
	    	document.getElementById("loader").style.display = "block";
	    	#server(..cLoadCountries(start,1,lastViewDate))#
	    	currentLoadData=start;
	    	currentOrder=1;
	    	document.getElementById("loader").style.display = "none";
	    	setTableBorderPos();
    	}
    	
    	// Sort table (1,2= Countrty code, 3,4=Countrty name, 5,6=AWSRegion)
    	function jSortTable(order){
	    	if(order==currentOrder){ return;}
		    if(document.querySelectorAll("tbody tr").length<=1){
		    	return;
		    }
	    	if(searching){
		    	jLoadSearchResults(order);
		    	return;
		    }
	    	document.getElementById("loader").style.display = "block";
	    	
	    	// POpulate table by sorting order
	    	#server(..cLoadCountries(currentLoadData,order,lastViewDate))#
	    	currentOrder = order;
	    	document.getElementById("loader").style.display = "none";
            setTableBorderPos();
    	}
    	
    	// Edit row, change Textcontents to input boxes
    	function editRow(e){
	    	if(currentTr==null){
	    		currentTr = e.target.parentElement.parentElement;
	    		let tds = currentTr.querySelectorAll("td");
	    		val1 = tds[1].textContent;
	    		val2 = tds[2].textContent;
	    		val3 = tds[3].textContent;
	    		val4 = tds[4].textContent;
	    		tds[1].innerHTML = "<input type='text' name='code' value='"+val1+"'>";
	    		tds[2].innerHTML = "<input type='text' name='name' value='"+val2+"'>";
	    		tds[3].innerHTML = "<div class='date-format-dropdown dropdown-btn' onclick='openDateFormatDropdown(event)'>"+val3+ dropDownText+"</div>";
	    		tds[4].innerHTML = "<input type='text' name='region' value='"+val4+"'>";
	    		tds[5].classList.add("hidden");
                document.querySelector(".btn-edit-group").style.display="block";
    			document.querySelector(".add-row").style.display="none";
	    	}
	    	else{
		    	alert("You cannot edit multiple testnames at the same time");
	    	}
            setTableBorderPos();
    	}
    	
    	// Cancel edit, change input boxes to Textcontents
    	function cancelEdit(){
	    	if(currentTr==document.querySelector("tbody").firstElementChild && currentTr.classList.contains("new")){
		    	document.querySelector("tbody").firstElementChild.remove();
	    	}
	    	else{
	    		tds = currentTr.querySelectorAll("td");
	    		tds[1].innerHTML = val1;
	    		tds[2].innerHTML = val2;
	    		tds[3].innerHTML = val3;
	    		tds[4].innerHTML = val4;
	    		tds[5].classList.remove("hidden");
	    	}
	    	currentTr = null;
    		document.querySelector(".btn-edit-group").style.display="none";
    		document.querySelector(".add-row").style.display="block";
            setTableBorderPos();
    	}
    	
    	// Validate input boxes, if passes,activate Confirm popup to save edit 
        function saveRow(){
	    	let tds = currentTr.querySelectorAll("td");
	    	if(tds[2].querySelector("input").value==""){
		    	setTimeout(()=>popup4.classList.remove("inactive"),100);
		    	return;
	    	}
	    	if(currentTr.classList.contains("new")){
	    		document.getElementById("save-val").innerHTML = "\""+tds[2].querySelector("input").value+"\"";
	    		document.getElementById("save-val1").innerHTML = tds[2].querySelector("input").value;
	    	}
	    	else{
	    		document.getElementById("save-val").innerHTML = "changes";
	    	}
	    	setTimeout(()=>popup3.classList.remove("inactive"),100);
    	}
    	// Deactivate popups
        function removePopup1(){
            popup1.classList.add("inactive");
        }
        function removePopup2(){
            popup2.classList.add("inactive");
        }
        function removePopup3(){
            popup3.classList.add("inactive");
        }
        function removePopup4(){
            popup4.classList.add("inactive");
        }
        function removePopup5(){
            popup5.classList.add("inactive");
        }
        function removePopup6(){
            popup6.classList.add("inactive");
        }
        
        // save edits
        function confirmSave(){
	    	let tds = currentTr.querySelectorAll("td");
	    	let id;
	    	val1 = tds[1].querySelector("input").value;
	    	val2 = tds[2].querySelector("input").value;
	    	val3 = tds[3].querySelector("div").textContent;
	    	val4 = tds[4].querySelector("input").value;
	    	if(currentTr.classList.contains("new")){
		    	id=""
	    	}
	    	else{
		    	id=currentTr.getAttribute("key");
	    	}
		    #server(..cSaveUpdateCountry(id,val1,val2,val3,val4))#
		    if(dataExist){
			    dataExist=false;
			    removePopup3();
			    return;
		    }
	    	tds[1].innerHTML = val1;
	    	tds[2].innerHTML = val2;
	    	tds[3].innerHTML = val3;
	    	tds[4].innerHTML = val4;
            tds[5].classList.remove("hidden");
	        currentTr.classList.remove("new");
	        currentTr.classList.add("highlight");
	    	popup3.classList.add("inactive");
    		document.querySelector(".btn-edit-group").style.display="none";
    		document.querySelector(".add-row").style.display="block";
    		currentTr=null;
    	}
    	// Add new row of input boxes to enter values
    	function addRow(e){
	    	let tempTable = document.querySelector(".temp-table");
	    	let tbody = document.querySelector("tbody");
	    	let tr = document.createElement("tr");
	    	tr.classList.add("new");
            let tableData = "<td class='id'>---</td>";
            tableData = tableData+"<td class='code'><input type='text' name='code' value=''></td>";
            tableData = tableData+"<td class='name'><input type='text' name='name' value=''></td>";
            tableData = tableData+"<td class='date-format'><div class='date-format-dropdown dropdown-btn' onclick='openDateFormatDropdown(event)'>" + dropDownText+"</div></td>";
            tableData = tableData+"<td class='region'><input type='text' name='region' value=''></td>";
            tableData = tableData+"<td class='actions hidden'><img class='edit-icon' src='./assets/images/edit.png' alt='Edit' onclick='editRow(event)'> <img src='./assets/images/delete.png' alt='Delete' onclick='deleteRow(event)'></td>"
	    	tr.innerHTML = tableData;
    		tbody.prepend(tr);
    		currentTr = tr;
    		tempTable.scrollTop = 0;
    		e.target.style.display="none";
    		document.querySelector(".btn-edit-group").style.display="block";
            setTableBorderPos();
    	}
    	
    	// Activate Date format dropdown in new row and edit row
    	function openDateFormatDropdown(e){
            let position = e.target.getBoundingClientRect();
            dateFormatData.style.top = position.bottom + 2 + "px";
            dateFormatData.style.left = position.left + "px";
            dateFormatData.style.width = position.width + "px";
            setTimeout(()=>{
                dateFormatData.classList.add("active");
            },100);
        }
        
        // Selecting dater format and deactivate dropdown
        function changeDateFormat(e){
            let date = e.target.textContent;
            currentTr.querySelector(".date-format-dropdown").innerHTML=date + dropDownText;
            dateFormatData.classList.remove("active");
        }
        
        // activate confirmation popup to Delete
    	function deleteRow(e){
	    	currentTr = e.target.parentElement.parentElement;
            let value = currentTr.querySelectorAll("td")[1].textContent;
	    	document.getElementById("del-val").innerHTML = value;
	    	document.getElementById("del-val1").innerHTML = value;
	    	setTimeout(()=>{
	    		popup1.classList.remove("inactive");
	    	},100);
    	}
    	
    	// delete row data
    	function confirmDelete(){
	    	removePopup1();
	    	#server(..cDeleteCountry(currentTr.getAttribute("key")))#
    		currentTr.remove();
    		currentTr=null;
            setTimeout(()=>{
                popup2.classList.remove("inactive");
            },100)
            setTableBorderPos();
    	}
        function cancelDelete(){
            currentTr=null;
            removePopup1();
        }
        
        // Activate suggestions under search bar
        function searchDataChange(e){
	        searching = true;
	        if(e.keyCode==13){//Enter Key
		        currentLoadData = e.target.value;
		        jLoadSearchResults(1);
		        setTableBorderPos();
			    return;
	        }
	        if(e.target.value.length==0){
		        searchData.classList.remove("active");
		        currentOrder=1
		        return;
	        }
	        let position = e.target.closest(".search-group").getBoundingClientRect();
            searchData.style.top = position.bottom + 2 + "px";
            searchData.style.left = position.left;
           	if(e.target.value==prevSearchData){}
	        else{
		        prevSearchData=e.target.value;
	        	#server(..cClearSearchData())#
	        	#server(..cSearchCountries(e.target.value))#
	        	#server(..cLoadSearchSuggestions())#
	        	setTimeout(()=>{
              		searchData.classList.add("active");
               		if(searchData.getBoundingClientRect().width < position.width){
                   		searchData.style.width = position.width;
               		}
           		},100);
	        }
        }
        // Load search result on table
        function jLoadSearchResults(order){
	    	document.getElementById("loader").style.display = "block";
	        #server(..cLoadSearchResults(order))#
	        currentOrder = order;
			searchData.classList.remove("active");
	    	document.getElementById("loader").style.display = "none";
        }
        
        // Select a result from suggestions
        function jLoadSearchData(e){
	    	document.getElementById("loader").style.display = "block";
	        searching = true;
	        let searchVal = e.target.textContent;
	        document.getElementById("search").value = searchVal;
            searchData.classList.remove("active");
	        let search = e.target.getAttribute("value").split(":");
	        let searchType = search[0];
	        let searchId = search[1];
	        #server(..cClearSearchData())#
	        switch(searchType){
		        case 'Code':#server(..cLoadResultById(id))#;break;
		        case 'Name':#server(..cSearchName(searchVal))#;break;
		        case 'DateFormat':#server(..cSearchDateFormat(searchVal))#;break;
		        case 'Region':#server(..cSearchRegion(searchVal))#;break;
	        }
	        currentLoadData=searchVal;
	        jLoadSearchResults(1);
            setTableBorderPos();
        }
    </script>
<script language="cache" method="cInitMe">
	d InitMe^cCountry
</script>

<script language="cache" method="cLoadCountries" arguments="d1:%String,orderCol:%Integer,lastViewDate:%String">
	; Populate Table
	d LoadCountries^cCountry(d1,orderCol,lastViewDate)
</script>
<script language="cache" method="cSaveUpdateCountry" arguments="id,code,name,dateFormat,region:%String">
	// Edited country
	d SaveUpdateCountry^cCountry
</script>
<script language="cache" method="cDeleteCountry" arguments="id:%String">
	//Delete country
	d DeleteCountry^cCountry
</script>
<script language="cache" method="cClearSearchData">
	k ^SearchCode
	k ^SearchName
	k ^SearchRegion
	k ^SearchData
</script>
<script language="cache" method="cSearchCountries" arguments="searchVal:%String">
	d SearchData^cCountry
</script>
<script language="cache" method="cSearchName" arguments="searchVal:%String">
	d SearchName^cCountry
</script>
<script language="cache" method="cSearchDateFormat" arguments="searchVal:%String">
	d SearchDateFormat^cCountry
</script>
<script language="cache" method="cSearchRegion" arguments="searchVal:%String">
	d SearchRegion^cCountry
</script>
<script language="cache" method="cLoadSearchSuggestions">
	d LoadSearchSuggestions^cCountry
</script>
<script language="cache" method="cLoadSearchResults" arguments="orderCol:%String">
	d LoadSearchResults^cCountry
</script>
<script language="cache" method="cLoadResultById" arguments="id:%String">
	d LoadResultById^cCountry
</script>
</html>
