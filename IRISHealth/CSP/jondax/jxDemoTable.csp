<html lang="en">
    <head>
    	<script language="cache" runat="server">d HEAD1^WSP999</script>
        <link rel="stylesheet" href="assets/styles/jxConvertResultTableB2B.css">
    </head>
    <body>
        <div id="wrapper">
            <div class="bg-wrapper">
                <div class="bg3">
                    <img src="./assets/images/bg3.png">
                </div>
            </div>
            <div id="loader" class="loader">
            	<div class="loader-content">
            		<p>Please wait for all the data to be loaded!</p>
            		<div class="lds-ring"><div></div><div></div><div></div><div></div></div>
            	</div>
            </div>
            <div class="content">
                <div class="main-field">
                    <i class="fa fa-bars mobile-active nav-toggle" style="color: #ffffff;" onclick="openMobileNav(event)"></i>
                    <img class="logo mobile-active" src="./assets/images/Jonda X Logo White Pink.png" alt="Jonda Health">
                    <h1>
                        Data Transformation
                    </h1>
                    <div id="lab-result" class="lab-result">
                        <div class="result-title">
                            <h2>Converted Result</h2>
                            <h3>Template: <span id="templateName" name="templateName" style="color:#ff0066;/* cursor:pointer*/" ></span></h3> <!--onclick="jPopTemplates()"-->
                            <button class="pink-btn" onclick="jDownloadFile()">Download <span id="file-type"></span> File</button>
                        </div>
                        <div class="result-table">
                            <!--<div class="table-border"></div>-->
                            <div class="table-container">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                        	<!--
                                        	<th>Date</th>
                                        	<th>Original Name</th>
                                            <th>Converted Name</th>
                                            <th>Units</th>
                                            <th>Value</th>
                                            <th>Low Range</th>
                                            <th>High Range</th> -->
                                            <th class="date">Date</th>
                                            <th class="test-name">Original Name</th>
                                            <th class="transformed-name">Transformed Test Name</th>
                                            <th class="result">Result</th>
                                            <th class="from-unit">From Unit</th>
                                            <th class="convert-result" colspan="2">Converted Result</th>
                                            <th class="l-range">Lower Range</th>
                                            <!-- colspan="2" -->
                                            <th class="transformed-lRange">Converted Lower Range</th>
                                            <th class="u-range">Upper Range</th>
                                   			<!-- colspan="2" -->	
                                            <th class="transformed-uRange">Converted Upper Range</th>
                                            <th class="comment" style='display:none;'>Comments</th>  <!--style="display:none;"-->
                                            
                                            
                                        </tr>
                                    </thead>
                                    
                                    <tbody id="tableBody">
                                    <script language="cache" runat="server">
										do PopTable^jxDemoTable
                            		</script>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button class="back-btn green-btn" onclick="toUploadScreen(event)">Go Back</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="popup1" class="popup inactive">
            <div class="popup-dialog">
                <img src="./assets/images/success.png" alt="Signup Success">
                <h4>Return to file upload screen?</h4>
                <p>You cannot go back to the current page <br> to download this converted file.</p>
                <div class="agree">
                    <div class="round">
                        <input name="C1" id="C1" type="checkbox" checked>
                        <label for="C1"></label>
                    </div>
                    <p>Do not show this again</p>
                </div>
                <div class="btn-group">
                    <button class="green-btn" onclick="jDoNotShow();jFileDelete();">Okay</button>
                    <button class="pink-btn" onclick="removePopup(event)">Cancel</button>
                </div>
            </div>
        </div>
        <script>
            var resizefunc = [];
        </script>
        <!-- jQuery  -->
		<script language="cache" runat="server">
			d jQueryCore^WSP999
		</script>
    </body>
    <script type="text/javascript">
    	DoNotShow=0
    	
		window.onload = jInitMe;
  		document.onmousemove = parent.resetTimer;
  		document.onmousedown = parent.resetTimer; // touchscreen presses
  		document.ontouchstart = parent.resetTimer;
  		//document.onclick = parent.resetTimer; // touchpad clicks
  		document.onkeypress = parent.resetTimer;
  		document.addEventListener('scroll', parent.resetTimer, true);
    	
    	function jInitMe(){
	    	parent.resetTimer();
	    	#server(..cInitMe())#;
	    	document.getElementById("loader").style.display = "none";
	    	//setTableBorderPos();
    	}
        let height = screen.height;
        let popup = document.getElementById("popup1")
        let tableContainer = document.getElementsByClassName("table-container")[0];
        let tableBorder = document.getElementsByClassName("table-border")[0];
		let downloadStr;
		let fileType;
		let fileName;
		let fileExt="hl7";
		let formalFileExt;
		window.onresize = setTableBorderPos;
        window.onload = jInitMe;
        
		
		function checkFileType(){
			fileExt = "hl7";
		}
        function setTableBorderPos(){
            let resultTable = document.querySelector(".result-table");
            let table = document.querySelector("table");
            let tablePosition = table.getBoundingClientRect();
            if(resultTable.scrollHeight > resultTable.clientHeight){
                tableBorder.style.height = "calc(100% + 4px)"
            }
            else{
                tableBorder.style.height = tablePosition.height + 4 + "px";
            }
            tableBorder.style.width = tablePosition.width + 4 + "px";
        }
        function toUploadScreen(e){
	        if (DoNotShow==1){
		        jFileDelete();
				window.frameElement.src = './jxDemoMain.csp'
		        return false
		    }
            setTimeout(()=>{
                popup.classList.remove("inactive")
            },100);
        }
        function removePopup(e){
            popup.classList.add("inactive");
        }
        function openDropdown(e){
            let collapseData = e.target.closest("td").querySelector(".collapse-data");
            let resultTablePosition = document.querySelector(".result-table").getBoundingClientRect();
            
            let ul = collapseData.querySelector("ul");
            let collapsePosition = e.target.getBoundingClientRect();
            if(height - e.target.getBoundingClientRect().bottom <360){
                collapseData.style.bottom = "1.7vw";
                ul.style.maxHeight = (collapsePosition.top - resultTablePosition.top -70  ) + "px";
                collapseData.style.maxHeight = (collapsePosition.top - resultTablePosition.top -40) + "px";
            }
            else{
                ul.style.maxHeight = (resultTablePosition.bottom  - collapsePosition.bottom - 30) + "px";
                collapseData.style.maxHeight = (resultTablePosition.bottom  - collapsePosition.bottom - 10) + "px";
            }
            setTimeout(()=>{
                collapseData.classList.add("active");
            },100);
        }

        document.addEventListener("click",(e)=>{
            let collapseData = e.target.closest(".collapse-data.active");
            if(collapseData == null){
                $(".collapse-data.active").removeClass("active");
            } 
            if(e.target.closest(".popup-dialog") == null){
                popup.classList.add("inactive");
            }
        })
        
        function jDoNotShow(){
	        if (document.getElementById("C1").checked==true){
		        #server(..cDoNotShow())#
	        }
        }
        
        function jPopTemplates(){
	     //	#server(..cPopTemplates())#
	     //	location.reload()
        }
        function jDownloadFile(){
			#server(..cSaveRBT())#
			checkFileType();
    		var blob = new Blob([downloadStr], {type: 'text/plain'});
    		var link = document.createElement('a');
    		link.href = URL.createObjectURL(blob);
    		link.href="jxDemo/output/"+fileName+"."+fileExt
    		link.download = fileName+"."+fileExt;
    		link.click();
    		//console.log(link.href);
    		URL.revokeObjectURL(link.href);
    		//#server(..cDeleteHL7())#
    		
		}
		function jFileDelete(){
			#server(..cDeleteHL7(fileName+"."+fileExt))#
			window.frameElement.src = './jxDemoMain.csp'
			}
		//not use
        function jSaveResult(){
	        
        // Pull data from current result table
	    	const tableBody = document.getElementById("tableBody");
	    	const tableRows = tableBody.querySelectorAll('tr');
	    	tableRows.forEach((row,index) => {
		    	
		    	const testName = row.querySelector('td.transformed-name').textContent.trim();
		    	if (testName == ""){return;}
		    	const testValue = row.querySelector('td.convert-result-val').textContent.trim();
		    	const testUnit = row.querySelector('td.convert-result-unit').textContent.trim();
		    	const testLoRange = row.querySelector('td.l-result-val').textContent.trim();
		    	const testHiRange = row.querySelector('td.u-result-val').textContent.trim();
	    		const testDate = row.querySelector('td.date').textContent.trim();
	    		const textarea = row.querySelector('td.comment textarea');
				const testComment = textarea ? textarea.value : "";

	    		console.log(testName, testValue, testUnit, testHiRange, testLoRange);
	    		
	    		// Save data to ResultBloodtest_Tests
	    		#server(..cSaveRBT(testName, testValue, testUnit, testHiRange, testLoRange, testDate,testComment))#;
	    	}
	    	)
    	}
	</script>
</script>
<script language="cache" method="cInitMe">
	d InitMe^jxDemoTable
	
	i '$d(%session.Data("jxAltConvertResultTable","Template")) s %session.Data("jxAltConvertResultTable","Template")="JondaX"
	&js<document.getElementById("templateName").innerHTML="#(%session.Data("jxAltConvertResultTable","Template"))#">
</script>

<script language="cache" method="cSaveRBT" arguments="d2,d3,d4,d5,d6,d7,d8:%String">
	s UserID=$g(%session.Data("UserID"))
	s fext=$g(^jxDemo(UserID,"fileExt"))
	s fileName=$g(^jxDemo(UserID,"fileName"))
	s fileName=$replace(fileName,"."_fext,"")_"-output"
	;s fileName=$p(%session.Data("jxAltUploadRecord"),".",1)_"-output"
	&js<fileName=`#(fileName)#`>
	q
</script>
<script language="cache" method="cDeleteHL7" arguments="d1:%String">
	d ##class(%File).Delete("C:\InterSystems\Cache\CSP\jondax\jxDemo\output\"_d1)
	k ^jxDemo($g(%session.Data("UserID")))
</script>
<script language="cache" method="cDoNotShow">
	d DoNotShow^jxDemoTable
</script>

<script language="cache" method="cPopTemplates">
	i %session.Data("jxAltConvertResultTable","Template")="JondaX" s %session.Data("jxAltConvertResultTable","Template")="Biolytica" 
	e  i %session.Data("jxAltConvertResultTable","Template")="Biolytica" s %session.Data("jxAltConvertResultTable","Template")="Elfie" 
	e  s %session.Data("jxAltConvertResultTable","Template")="JondaX"
	
</script>
</html>
