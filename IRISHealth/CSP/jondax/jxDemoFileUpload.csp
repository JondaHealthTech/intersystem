<html lang="en">
    <head>
	<script language="cache" method="OnPreHTTP" arguments="" returntype="%Boolean">
		i $g(%session.Data("UserID"))="" s %response.Redirect="jxLockDown.csp" q 1
		q 1
	</script>
	<script language="cache" runat="server">
		s id=$g(%session.Data("UserID"))
		d HEAD1^WSP999
	</script>
        <link rel="stylesheet" href="assets/styles/jxDemoFileUpload.css">
    </head>
    <body>
        <div id="loader" class="loader inactive">
        	<div class="loader-content">
        		<!--
        		<p>Step 1</p>
        		<p>File Uploading....</p>
        		<div class="lds-ring"><div>
        		</div><div></div><div></div><div></div></div> -->
        		<img src="./assets/images/JondaX-Process-Animation-2.gif" alt="Loading..." 
            	 style="width:100%;height:100%;">
        		
        	</div>
        </div>
           <div id="lab-upload" class="lab-upload">
                        <h4>Upload laboratory file</h4>
                        <img src="assets/images/upload.png" alt="Upload">
                        <p>
                            Drag and drop here<br>
                            or<br>
                        </p>
                        <input
                            type="file"
                            accept="image/*,.pdf,.hl7,.xml,.json,.xlsx"
                            id="fileupload"
                            style="display: none"
                            onchange="loader.classList.remove('inactive');changeFile(event)"
                       >
                        <button onclick="openFileDialog(event)">Upload</button>
                        <p class="note">File Formats: PDF or <span style="text-decoration:underline;text-decoration-style:dotted;cursor:help" title="bmp, heic, jpg, jpeg, gif, webp">images</span></span>.<br>Max size: 5MB per file</p>
            </div>
            <button
                class="inactive"
                id="BModal1"
                data-toggle="modal"
                data-target="#myModal1"
                type="button"
            >
            </button>
                
        </div>
        <div
            id="myModal1"
            class="modal fade"
            aria-labelledby="myModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <h2>Hang tight!</h2>
                        <h3>We're analysing your file...</h3>
                        <img
                            class="modal-img"
                            src="assets/images/analyzeData.png"
                            alt="Analysing Data"
                       >
                    </div>
                </div>
            </div>
        </div>
	    <div id="popup1" class="popup inactive">
		<div class="popup-dialog-gif" id="popup-dialog-gif">
			<!--
			<h4 class="heading">Step 1</h4>
            <h4 class="heading">File Uploading...</h4>
            
            <div class="progress">
			    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="30" style="width: 40%;height: 10vw;font-size: 10px;">
			      30%
			    </div>
			</div>
            -->
			<img src="./assets/images/JondaX-Process-Animation-2.gif" alt="Loading..." 
            	 style="width:100%;height:100%;">
			
		</div>
		</div> 
		<div id="popup2" class="popup inactive">
		<div class="popup-dialog">
			<!--<img src="./assets/images/trial/cross.png" alt="Close" class="close-btn" onclick="removePopup1()"> -->
			<img src="./assets/images/Exclamation.png" alt="Warning">
			<h4 class="heading">Unsupported file type!</h4>
            <h4 class="heading">Please upload correct file format</h4>
			
			<div class="btn-group">
                <button type="button" class="pink-btn" onclick="removePopup2()">OK</button>
            </div>
		</div>
		</div> 
        <script>
            var resizefunc = [];
        </script>
        <!-- jQuery  -->
		<script language="cache" runat="server">
			d jQueryCore^WSP999
		</script>
    </body>
    <script type="text/javascript">
		window.onload = parent.resetTimer;
  		document.onmousemove = parent.resetTimer;
  		document.onmousedown = parent.resetTimer; // touchscreen presses
  		document.ontouchstart = parent.resetTimer;
  		//document.onclick = parent.resetTimer; // touchpad clicks
  		document.onkeypress = parent.resetTimer;
  		document.addEventListener('scroll', parent.resetTimer, true);
  		
        const fileUpload = document.getElementById("fileupload");
        const modalBtn = document.getElementById("BModal1");
        const popup1 = document.getElementById("popup1");
        const popup2 = document.getElementById("popup2");
        let uploadedFile = undefined;
        const loader=document.getElementById("loader")
        function openPopup1(){
    		/*
    		setTimeout(()=>{
      		popup1.classList.remove("inactive")
    			},100); */
			popup1.classList.remove("inactive");
		}
		function removePopup1(){
	    	popup1.classList.add("inactive");
		}
		 function openPopup2(){
    		setTimeout(()=>{
      		popup2.classList.remove("inactive")
    			},100);
		}
		function removePopup2(){
	    	window.location.reload();
		}
        
        
        function openFileDialog(e) {
            fileUpload.click();
        }
        function changeFile(e) {
	        
	        //openPopup1();
            if (e.target.value.length != 0) {
            	uploadedFile = e.target.files[0];
            	modalBtn.click();
			// upload to server
				jUploadFile();
            }
        }
        document.body.addEventListener("drop", (ev) => {
            ev.preventDefault();
            if (ev.dataTransfer.items) {
                if (ev.dataTransfer.items[0].kind === "file") {
                    uploadedFile = ev.dataTransfer.items[0].getAsFile();
                }
            } else {
                uploadedFile = ev.dataTransfer.files[0];
            }
            //removeDragData(ev);
            loader.classList.remove("inactive");
            openPopup1();
			// upload to server
			jUploadFile()
        });
        document.body.addEventListener("dragover", (e) => {
            e.preventDefault();
        });
        function removeDragData(ev) {
            if (ev.dataTransfer.items) {
                ev.dataTransfer.items.clear();
            } else {
                ev.dataTransfer.clearData();
            }
        }
        function jUploadFile(){
	        //pollProgress();
	        /// IMPORTANT: CHECK FILE TYPE AND REJECT ANY non-pdf, image, xlsx, json, hl7 extensions
    		var formData = new FormData();
    		formData.append("fileupload", uploadedFile);
			fname=uploadedFile.name
			fname = fname.replace("&", " ");

  			var xhr = new XMLHttpRequest();
			// Upload data to server
			xhr.open("POST", "jxDemoFile.csp?FName=" + fname, true);
	
			xhr.send(formData);
  			xhr.onload = function(e) {
  				if (this.status == 200){		// added 2022-12-30 DW
					#server(..cCheckNext(uploadedFile.name.toLowerCase()))#
  				}	
    		}
		}
	
    </script>
    <script language="cache" method="cCheckNext" arguments="d1:%String">
		For i=1:1:100 {
		    
		    Hang 0.2
		 	if $d(^jxAltUpload(d1,"Uploaded")) {quit}
		   
		}

		i '$d(^jxAltUpload(d1)) &js<alert("Failed to upload file");window.location.reload();> q		; stop waiting after 5s
		i ^jxAltUpload(d1)=0 &js<openPopup2();> q		; wrong file type

		;i ^jxAltUpload(d1)'=0 &js<modalBtn.click(), window.open("jxAltConvertResultTable.csp","_self")>
		i ^jxAltUpload(d1,"Uploaded")'=0 d Structure^jxDemo h 6 &js< window.open("jxDemoDMT.csp","_self")>
		
	</script>
	</html>
